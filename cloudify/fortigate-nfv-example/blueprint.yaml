tosca_definitions_version: cloudify_dsl_1_3

description: >
  First basic blueprint.

imports:
  - http://www.getcloudify.org/spec/cloudify/4.0/types.yaml
  - http://www.getcloudify.org/spec/openstack-plugin/2.0.1/plugin.yaml

inputs:
  fos_imageid:
    default: {}
  fos_flavorid:
    default: {}
  key_name:
    default: {}
  ub_imageid:
     default: {}  
  ub_flavorid:
     default: {}
  fortimanagerip:
     default: {}

  mgmt_network_name:
    default: "mgmt"



dsl_definitions:

  openstack_config: &openstack_config
#    username: { get_input: keystone_username }
#   password: { get_input: keystone_password }
#  tenant_name: { get_input: keystone_tenant_name }
# auth_url: { get_input: keystone_url }

node_templates:

  my_floating_ip:
    type: cloudify.openstack.nodes.FloatingIP
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          inputs:
            args:
              floating_network_name: Ext-Net

  my_network:
    type: cloudify.openstack.nodes.Network
    properties:
      resource_id: my_network_openstack_name

  my_subnet:
    type: cloudify.openstack.nodes.Subnet
    properties:
      resource_id: my_subnet_openstack_name
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          inputs:
            args:
              cidr: 1.2.3.0/24
              ip_version: 4
      cloudify.interfaces.validation:
        creation:
          inputs:
            args:
              cidr: 1.2.3.0/24
              ip_version: 4
    relationships:
      - target: my_network
        type: cloudify.relationships.contained_in


  my_security_group:
    type: cloudify.openstack.nodes.SecurityGroup
    properties:
      resource_id: my_security_group_openstack_name
      rules:
        - remote_ip_prefix: 0.0.0.0/0
          port: 8080


  fortigate:
    type: cloudify.openstack.nodes.Server
    properties:
      server:
        image: { get_input: fos_imageid }
        flavor: { get_input: fos_flavorid }
        #useless key_name for fortinet but mandatory for openstack
        key_name: { get_input: key_name }
      agent_config:
        install_method: none # do not install agent
      openstack_config: *openstack_config
      management_network_name: { get_input: mgmt_network_name }
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          inputs:
            args:
              config_drive: true
              userdata: |
                #FOS VM Config File
                config sys global
                set hostname cloudify-vm
                end
                config system interface
                edit mgmt
                set mode dhcp
                set allowaccess ping https ssh http snmp fgfm
                set mtu-override enable 
                set mtu 1456
                next
                edit port1
                set mode dhcp
                set mtu-override enable 
                set mtu 1456
                set allowaccess ping
                next
                edit port2
                set mode dhcp
                set mtu-override enable 
                set mtu 1456
                set allowaccess ping
                next
                end
                config system dns
                set primary 10.10.10.1
                end
                config firewall policy
                edit 1
                set name "Allow any any"
                set srcintf "any"
                set dstintf "any"
                set srcaddr "all"
                set dstaddr "all"
                set action accept
                set schedule "always"
                set service "ALL"
                set nat enable
                next
                end
                config system central-management
                set include-default-servers disable
                set type fortimanager
                set fmg { get_input: fortimanagerip }
                config server-list
                edit 1
                set server-type update rating
                set server-address { get_input: fortimanagerip } 
                end
                end
#              files:
#               license: |
#                some text to put into the file
    relationships:
      - target: my_network
        type: cloudify.relationships.connected_to
      - target: my_subnet
        type: cloudify.relationships.depends_on
      - target: my_floating_ip
        type: cloudify.openstack.server_connected_to_floating_ip
      - target: my_security_group
        type: cloudify.openstack.server_connected_to_security_group



 client:
    type: cloudify.openstack.nodes.Server
    properties:
      server:
        image: { get_input: ub_imageid }
        flavor: { get_input: ub_flavorid }
        #useless key_name for fortinet but mandatory for openstack
        key_name: { get_input: key_name }
      agent_config:
        install_method: none # do not install agent
      openstack_config: *openstack_config
      management_network_name: { get_input: mgmt_network_name }
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          inputs:
            args:
              config_drive: true
              userdata: |
#              files:
#               license: |
#                some text to put into the file
    relationships:
      - target: my_network
        type: cloudify.relationships.connected_to
      - target: my_subnet
        type: cloudify.relationships.depends_on
      - target: my_floating_ip
        type: cloudify.openstack.server_connected_to_floating_ip
      - target: my_security_group
        type: cloudify.openstack.server_connected_to_security_group
